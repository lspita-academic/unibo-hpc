# HPC 2025/26 Final project

This repository contains the source code for the final project of the HPC 2025/26 course.

> [!important] Variants
> Even if the makefile specification can handle also CUDA, only the OpenMP and MPI variants are implemented, as requested by the assignment.

A serial version different from the one provided from the professor is also implemented, because I wanted to structure and modularize the code my way. The core logic behind is still the same.

## Notes

Weak linking is used to allow different sources to be compiled with different libraries. This allows to check if certain variant-specific functions are available and make decisions on which implementation to use.

To allow weak linking, pragma directives are used instead of gcc attributes to allow for better compatibility with different compilers.

See: [GCC weak linking pragma directive](https://gcc.gnu.org/onlinedocs/gcc/Weak-Pragmas.html).

An example can be found in [safety.c](src/safety.c).

## Build

### Make

```sh
make build-<variant>
```

Parameters:

- `<variant>`: Variant of the program, either serial, omp, mpi or cuda

A default `build` target is also provided to build all binaries, including [inputgen](#inputgen).

## Run

### Make

```sh
make run-<variant>
```

Parameters:

- `<variant>`: Variant of the program, either serial, omp, mpi or cuda
- `K`: Value of K (default: 5)
- `INPUT`: Input file path (default: demo.in, autogenerated if missing)
- `OUTPUT`: Output file path (default: demo.out)

> [!hint] Automatic dependency handling
> The `run` targets automatically build all the necessary files they need, so it's not required to run the corresponding `build` target before.

### Manual

All binaries are stored in the [BIN_DIR](#parameters) directory and follow the assignment specification for the parameters.

```sh
./bin/<variant>-k-means <K> <INPUT> <OUTPUT>
```

## Demo

To create a video demo, run the following command:

```sh
make demo-<variant>
```

With the following parameters:

- `<variant>`: Variant of the program, either serial, omp, mpi or cuda
- `DEMO_K`: Value of K (default: 5)
- `DEMO_INPUT`: Input file path (default: demo.in, autogenerated if missing)
- `DEMO_OUTPUT`: Output file path (default: demo.out)

> [!info] Demo parameters
> The parameters are named `DEMO_*` because they are used as default values by the other targets, so it's simpler to keep them distinct from the others.

To manually generate the demo input file, a target is provided:

```sh
make demo-input
```

Parameters:

- `DEMO_POINTS`: Number of points to use (default: 20)
- `DEMO_CLUSTERS`: Number of clusters to use (default: 50)
- `DEMO_INPUT`: File to generate (default: demo.in)

## Inputgen

An independent binary for input generation (provided by the professor) is also present among the other targets.

This is included to allow the autogeneration of the demo input file to always have an example to run even if no file is provided.

### Build

```sh
make build-inputgen
```

### Run

```sh
make run-inputgen
```

## Parameters

The parameters used by the targets are simple makefile variables. They can be overriden with environment variables using the same name or by providing them after the target name.

```sh
K=... make run-omp # using environment variables
# or
make run-omp K=... # providing them to the target manually
```

Here a complete list of parameters. If anything is missing, the [Makefile](./Makefile) can always be consulted.

> [!attention] List variables
> Lists are created in "append mode" (+=), so any provided value is added on top instead of replacing the entire variable.

> [!attention] Sources types
> The correct compilers and flags to use are selected based on the name of the files.
>
> - `omp-`: Sources that use OpenMP.
> - `mpi-`: Sources that use MPI.
> - `cuda-`: Sources that use CUDA. THE EXTENSION `.cu` IS IGNORED, CUDA SOURCES MUST START WITH THIS PREFIX TO USE THE CORRECT COMPILER.
>
> All other sources are considered standard C with no special requirements.

### Programs and flags

- `CC`: Compiler for standard c sources (default: gcc).
- `MPICC`: Compiler for MPI sources (default: mpicc).
- `NVCC`: Compiler for CUDA sources (default: nvcc).
- `CFLAGS`: Flags to use when compiling all sources. The -std flag is ignored for CUDA sources. (default: -std=c99 -Wall -Wpedantic).
- `OMP_FLAGS`: Flags to add for OpenMP sources (default: -fopenmp).
- `NVCC_FLAGS`: Flags to add for CUDA sources (default: -Wno-deprecated-gpu-targets).
- `MPIRUN`: Wrapper to use to run MPI binaries (default: mpirun).
- `MPIRUN_FLAGS`: Flags to add to the wrapper when running MPI binaries (default: "").
- `MAKE`: Make program to use when running targets inside targets, e.g. inside the demo target (default: make).

### Directories

- `SRC_DIR`: Directory containing the source files (default: src).
- `BUILD_DIR`: Directory to use for build artifacts (default: build).
- `BIN_DIR`: Directory to use for compiled binaries (default: bin).
- `SCRIPTS_DIR`: Directory containing extra scripts (default: scripts).

### Demo

- `DEMO_DIR`: Directory containing the demo files (default: demo).
- `DEMO_K`: K value for the demo (default: 5).
- `DEMO_POINTS`: Number of points for the demo (default: 20).
- `DEMO_CLUSTERS`: Number of clusters for the demo (default: 50).
- `GENERATE_FRAMES_SCRIPT`: script inside the scripts dir to generate the demo frames (default: generate_frames.sh).
- `DEMO_INPUT`: Input file for the demo (default: demo.in, autogenerated if missing).
- `DEMO_OUTPUT`: Output file for the demo (default: demo.out).

### Arguments

- `K`: K value to use (default: $(DEMO_K))
- `INPUT`: Input file to use (default: $(DEMO_INPUT), autogenerated if missing)
- `OUTPUT`: Output file to use (default: $(DEMO_OUTPUT))
